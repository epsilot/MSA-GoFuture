# Проработка компонентов EDA

## Детали реализации Kafka кластера

- Предлагается использовать единый кластер Kafka для объединения различных регионов развёртывания.
- Такой подход позволит обеспечить сохранность данных, а также работоспособность приложения в условиях отключения
  региона.
- Для обеспечения сохранности данных предлагается использовать rack awareness с региональной разбивкой.
- Replication Factor = 3, In-Sync Replicas = 2, ack=all

## Детали реализации мониторинга

- На уровне региона присутствия предлагается развернуть региональную систему мониторинга
  (Prometheus, Grafana, Alertmanager и т.п.).
- В существубщем кластере, либо в отдельном класетере для повышения надёжности предалается развернуть
  глобальную систему мониторинга, которая будет получать агрегированные метрики от регионов.

## События

### Примеры доменных событий в системе

| Домен     | Событие                    | Описание                              |
|-----------|----------------------------|---------------------------------------|
| Booking   | BookingRequested           | Пользователь запросил поездку         |
| Booking   | BookingMatched             | Водитель найден и назначен            |
| Booking   | DriverLocationUpdated      | Геопозиция водителя обновлена         |
| Billing   | PriceCalculated            | Рассчитана стоимость поездки          |
| Billing   | PaymentProcessed           | Платеж клиента успешно списан         |
| AntiFraud | SuspiciousActivityDetected | Обнаружена подозрительная активность  |


### Выбор типа SAGA 

- Так как ожидается большой объём запросов, при достаточно линейном процессе бронирования поездки, то видится
  оправданным использовать Anthology Saga.
- Такой подход позволит обеспечить высокую пропускную способность и будет хорошо сочетаться с проектируемой EDA.

### SAGA бронирования поездки

| Транзакция (Домен)                | Тип            | Компенсация       | Описание                                                                                                                                                                    |
|-----------------------------------|----------------|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| CREATE_BOOKING (Booking)          | Компенсируемая | BOOKING_FAILED    | Сервис Booking создает заявку на поездку                                                                                                                                    |
| PRICE_CALCULATION (Billing)       | Повторяемая    | -                 | Сервис Billing рассчитывает базовую стоимость                                                                                                                               |
| ANTIFRAUD_CHECK (AntiFraud)       | Повторяемая    | -                 | Сервис AntiFraud проверяет пользователя/маршрут                                                                                                                             |
| HOLD_MONEY (Billing)              | Компенсируемая | UNHOLD_MONEY      | Сервис Billing холдирует средства на счете пассажира                                                                                                                        |
| UNHOLD_MONEY (Billing)            | Повторяемая    | -                 | Снимает холдирование средств (в случае отмены, фрода или ошибки)                                                                                                            |
| SEARCH_DRIVER (Booking)           | Компенсируемая | CANCEL_ASSIGNMENT | Сервис Booking ищет и резервирует подходящего водителя                                                                                                                      |
| CANCEL_ASSIGNMENT (Booking)       | Повторяемая    | -                 | Отменяет резервирование водителя, возвращая его в пул                                                                                                                       |
| CONFIRM_BOOKING (Booking)         | Необратимая    | -                 | Сервис Booking фиксирует поездку как подтвержденную                                                                                                                         |
| BOOKING_FAILED (Booking)          | Необратимая    | -                 | Фиксирует окончательный сбой бронирования (после сбоя на этапе поиска водителя или платежа), обновляет статус в базе данных и инициирует уведомление пользователя об отмене |
| CHARGE_MONEY (Billing)            | Необратимая    | -                 | Сервис Billing выполняет списание захолдированных средств                                                                                                                   |
| ESCALATE_SAGA (Billing/AntiFraud) | Необратимая    | -                 | Отправляет сбойную транзакцию или подозрительную активность на ручную обработку (например, для проверки фрода или проблем с банком).                                        |

## Основные топики

| Топик                | Ключ           | Описание                       |
|----------------------|----------------|--------------------------------|
| ride-events          | ride_id        | События о поездках             |
| driver-locations     | driver_id      | События о положении водителя   |
| billing-events       | transaction_id | Информация о платежах          |
| booking-commands     | booking_id     | События о бронировании поездки |

## Примеры метрик для мониторинга

#### Latency
| Система / Компонент   | Метрика                            | Описание                                                              |
|-----------------------|------------------------------------|-----------------------------------------------------------------------|
| API Gateway / Сервисы | http_request_duration_seconds_p99  | 99-й перцентиль времени ответа API                                    |
| БД                    | db_query_latency_p95               | 95-й перцентиль времени выполнения критических запросов (по сервисам) |
| Kafka                 | kafka_consumer_lag_seconds         | Время отставания от лидера партиции                                   |
| Kafka                 | kafka_producer_request_latency_avg | Средняя задержка подтверждения записи                                 |
| Распред. Транзакция   | saga_booking_duration_seconds_p95  | 95-й перцентиль времени выполнения саги бронирования                  |
| Бизнес                | business_avg_booking_waiting_time  | Среднее время ожидания подбора водителя                               |

#### Traffic

| Система / Компонент   | Метрика                               | Описание                                         |
|-----------------------|---------------------------------------|--------------------------------------------------|
| API Gateway / Сервисы | http_requests_total_per_second        | Количество запросов в секунду (по сервисам)      |
| Kafka                 | kafka_record_send_rate                | Рейт запросов отправляемых в топик в секунду     |
| БД                    | db_rps                                | Количество запросов в секунду в БД (по сервисам) |
| Бизнес                | business_total_success_booking_rate   | Рейт успешных бронирований в единицу времени     |

#### Errors

| Система / Компонент   | Метрика                       | Описание                                |
|-----------------------|-------------------------------|-----------------------------------------|
| API Gateway / Сервисы | http_responses_total_5xx_rate | Доля ответов с кодом 5xx                |
| Kafka                 | kafka_producer_error_rate     | Доля ошибок при записи сообщений        |
| Бизнес                | business_payment_failure_rate | Процент неудачных попыток платежей      |
| БД                    | db_deadlocks_total            | Количество обнаруженных взаимоблокировок |

#### Saturation

| Система / Компонент | Метрика                      | Описание                                                                            |
|---------------------|------------------------------|-------------------------------------------------------------------------------------|
| Сервисы             | node_cpu_utilization_avg     | Средняя загрузка CPU нод                                                            |
| Kafka               | kafka_server_replica_max_lag | Максимальное отставание реплик                                                      |
