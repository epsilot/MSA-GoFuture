# Обеспечение геораспределённости, обеспечение реплицироания и failover

## Выбор регионов для размещения

- В качестве региона для размещения в Юго-Восточной Азии следует выбрать Сингапур. Данный регион имеет высокую
  связность и низкий RTT со всеми ключевыми странами региона за счёт наличия крупнейших точек обмена трафика.
- Руководствуясь аналогичным соображениями в качестве точки присутствия в Латинской Америке следует выбрать Сан-Паулу в
  Бразилии.

## Схема репликации

- Так как для взаимодействия выбран единый кластер Kafka между разными точками присутствия, реплицирование будет
  обеспечено автоматически по средствам rack awareness. Данные с каждого региона буду реплицироваться в остальных
  регионах.
- В случае необходимости повысить скорость записи следует убрать требования подтверждения записи в репликацию в другом
  регионе, однако следует учитывать, что, в случае инцидента, это может привести к потере наиболее свежих данных.
- Реплицирование PostgreSQL можно реализовать штатными средствами реплицирования самой БД. 


## Схема реализации геомаршрутизации

- Для реализации первого уровня маршрутизации следует использовать GeoDNS, который будет выдавать IP адрес регионального
  балансировщика.
- Это может быть как часть API Gateway, так и дополнительный промежуточный слой, что позволит более гибким образом
  управлять нагрузкой на конкретный регион.
- В случае необходимости (например при перемещении пользователей между регионами) имеет смысл предусмотреть механизм
  перенаправления пользователя в "домашний" регион. Имеет смысл делать это на уровне API Gateway, так как этот уровень
  имеет доступ до информации о пользователях, что позволит безопасно получить требуемую метаинформацию.

## Аварийного переключения 

- В случае возникновения инцидента ключевыми задачами являются продолжение предоставления услуг пользователям
  (даже с учётом повышения RTT), а также обеспечение сохранности данных.
- При отключении региона GeoDNS и Kafka не потребуют дополнительной автоматизации для переключения пользователей.
- Для PostgreSQL имеет смысл ввести использования Patroni для автоматического промоутирования репликации для мастера.
  Хотя отключение региона присутствия на уровне GeoDNS в случае возникновения проблем позволит перевести новый трафик с
  проблемного региона, имеет смысл предусмотреть дополнительный механизм отключения трафика на уровне региона (например
  на фаерволе), что исключить возможность разделённого мастера.

## Таблица отказов

| Точка отказа             | Критичность      | Действия                                                                                                                                                                 |
|--------------------------|------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ДЦ                       | Очень Высокая    | Автоматическое переключение на уровне GeoDNS. Требует немедленного эскалирования до бизнеса                                                                              |
| PostgreSQL               | Высокая          | Автоматическое промоутирование реплики и перенаправление трафика. Требует оперативного устранения и ручно переключения на региональный мастер                            |
| Kafka                    | Высокая          | Автоматическое промоутирование реплики и перенаправление трафика. Требует оперативного устранения, так как приведёт к увеличению RTT и ухудшению пользовательского опыта |
| Prometheus. Региональный | Средняя          | Требует устранения                                                                                                                                                       |
| Prometheus. Федеративный | Низкая           | Требует устранения. Можно использовать регионанльный мониторинг                                                                                                          |